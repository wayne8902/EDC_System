# EDC 系統權限判斷機制說明

## 概述

EDC（電子資料擷取）系統採用基於角色的權限控制（RBAC - Role-Based Access Control）機制，在用戶登入後自動判斷其權限範圍並顯示對應的功能介面。

## 權限判斷流程

### 1. 登入階段
- 用戶通過登入頁面輸入帳號密碼
- 系統驗證用戶身份並建立會話（Session）
- 將用戶基本資訊存入 Cookie（如 `user_id`、`unique_id`）

### 2. 權限載入階段
```javascript
// 頁面載入時自動執行
document.addEventListener('DOMContentLoaded', function() {
    loadUserInfo();           // 載入用戶基本資訊
    loadUserPermissions();    // 載入用戶權限
    updateLoginTime();        // 更新登入時間
    loadDashboardStats();     // 載入統計資料
});
```

### 3. 權限獲取
系統通過 API 調用獲取用戶權限：
```javascript
fetch('/permission/get_user_permissions')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            userPermissions = data.permissions || [];
            determineUserRole(data.roles || []);
            setupQuickActions();
            generateRoleDashboard();
        }
    });
```

## 角色判斷邏輯

### 權限優先級判斷
系統根據用戶擁有的權限自動判斷角色：

```javascript
function determineUserRole(roles) {
    if (userPermissions.includes('edc.system.admin')) {
        userRole = 'system_admin';        // 系統管理員
    } else if (userPermissions.includes('edc.data.freeze')) {
        userRole = 'monitor';            // 試驗監測者
    } else if (userPermissions.includes('edc.crf.sign')) {
        userRole = 'investigator';       // 試驗主持人
    } else if (userPermissions.includes('edc.data.create')) {
        userRole = 'researcher';         // 研究人員
    } else {
        userRole = 'sponsor';            // 試驗委託者（預設）
    }
}
```

### 角色權限對照表

| 角色 | 關鍵權限 | 功能範圍 |
|------|----------|----------|
| **系統管理員** | `edc.system.admin` | 用戶管理、權限管理、系統監控、審計記錄 |
| **試驗監測者** | `edc.data.freeze` | 資料審查、查詢管理、現場訪視、合規檢查 |
| **試驗主持人** | `edc.crf.sign` | CRF審查、電子簽署、受試者同意、不良事件 |
| **研究人員** | `edc.data.create` | 資料新增、編輯、驗證、查詢回應 |
| **試驗委託者** | 無特殊權限 | 資料瀏覽、報告查看、資料匯出 |

## 動態介面生成

### 1. 快速操作按鈕
根據用戶權限動態顯示可用的快速操作：
```javascript
const QUICK_ACTIONS_CONFIG = {
    'edc.data.create': { title: '新增資料', action: 'openDataEntry' },
    'edc.query.create': { title: '發起查詢', action: 'openQueryCreation' },
    'edc.crf.sign': { title: '電子簽署', action: 'openDigitalSignature' },
    // ... 其他權限配置
};
```

### 2. 角色專屬功能區
每個角色都有對應的功能卡片配置：
```javascript
const ROLE_CONFIG = {
    system_admin: {
        name: '系統管理員',
        color: '#dc3545',
        features: [
            { title: '用戶管理', description: '管理系統用戶帳號、權限和角色分配' },
            { title: '權限管理', description: '配置系統權限、角色和存取控制' },
            // ... 其他功能
        ]
    },
    // ... 其他角色配置
};
```

### 3. 權限說明表格
為所有用戶顯示系統角色權限對照表，幫助用戶了解不同角色的功能範圍。

## 安全機制

### 1. 前端權限控制
- 根據權限動態隱藏/顯示功能按鈕
- 防止用戶看到無權限的功能選項

### 2. 後端權限驗證
- 所有 API 調用都需要驗證用戶權限
- 防止前端繞過權限檢查

### 3. 會話管理
- 使用 Cookie 和 Session 管理用戶登入狀態
- 定期檢查會話有效性

## 擴展性設計

### 1. 權限配置化
- 所有權限定義都集中在配置對象中
- 新增權限只需修改配置，無需改動核心邏輯

### 2. 角色自定義
- 支援自定義角色和權限組合
- 靈活的權限分配機制

### 3. 功能模組化
- 每個功能都是獨立的模組
- 支援權限的細粒度控制

## 總結

EDC 系統的權限判斷機制通過以下步驟實現：

1. **登入驗證** → 建立用戶會話
2. **權限獲取** → 從後端 API 獲取用戶權限列表
3. **角色判斷** → 根據權限自動判斷用戶角色
4. **介面生成** → 動態生成對應角色的功能介面
5. **權限控制** → 隱藏無權限的功能，顯示權限說明

這種設計確保了系統的安全性、可用性和可維護性，用戶只能看到和操作其權限範圍內的功能。
